<!DOCTYPE html>
<html>

<head>

    <link rel="shortcut icon" href="/static/jpg/myjpg.jpg"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <!-- Stylesheets -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="/static/css/font-awesome.min.css" rel="stylesheet"/>
	<link href="/static/css/styles.css" rel="stylesheet"/>

    <script type="text/javascript" src="/static/js/jquery.min.js"></script>
    <script type="text/javascript" src="/static/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/static/js/modernizr.js"></script>
    <script type="text/javascript" src="/static/js/prefixfree.min.js"></script>
    <title>百哥么么哒|个人网站</title>

</head>


<body>
    <div class="navbar navbar-default navbar-fixed-top">
    <div class="container">
        <a class="navbar-brand brand" href="/">TTyb|个人网站</a>
        <div style="font-size: 6px;font-family: serif;text-decoration: none;">
            <ul class="nav navbar-nav">
                <li><a class="navbar-brand" href="/">首页</a></li>
                <li><a class="navbar-brand" href="/topic">文章</a></li>
                <li><a class="navbar-brand" href="/category">分类</a></li>
                <li><a class="navbar-brand" href="/log/log">日志</a></li>
                <li><a class="navbar-brand" href="/guestbook">留言</a></li>
            </ul>
        </div>

        <div class="pull-right">
            <div style="font-size: 4px;font-family: serif;">
                <ul class="nav navbar-nav">
                    <li>
                        <a href="/contact" class="navbar-brand">联系方式</a>
                    </li>
                    <li>
                        <a data-toggle="dropdown" class="dropdown-toggle navbar-brand" href="#">友情链接<strong
                                class="caret"></strong></a>
                        <ul class="dropdown-menu container-fluid" style="border-radius: 6px 6px 6px 6px;">
                            <li><a href="http://www.cnblogs.com/TTyb">TTyb博客园</a></li>
                            <li><a href="http://www.cnblogs.com/nima">一只尼玛博客园</a></li>
                            <li><a href="https://github.com/TTyb">TTybGithub</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>

    </div>
</div>

        <div class="container">
    <div class="page-header">
        <hr>
        <h3>python3百度指数抓取</a></h3>
        <small>
            分类：python
        </small>
        <h6 class="text-muted">作者:TTyb&nbsp;&nbsp;文章发表于 2016-11-12</h6>
        <br/>
        <p class="content text-overflow">
            <h1 id="百度指数抓取再用图像识别得到指数">百度指数抓取，再用图像识别得到指数</h1>

<h2 id="前言">前言：</h2>
<p>土福曾说，百度指数很难抓，在淘宝上面是20块1个关键字：
<img src="http://images2015.cnblogs.com/blog/996148/201611/996148-20161110162432795-1923984431.png" alt="" /></p>

<p>哥那么叼的人怎么会被他吓到，于是乎花了零零碎碎加起来大约2天半搞定，在此鄙视一下土福</p>

<h3 id="安装的库很多">安装的库很多：</h3>
<blockquote>
  <p>谷歌图像识别tesseract-ocr</p>
</blockquote>

<blockquote>
  <p>pip3 install pillow</p>
</blockquote>

<blockquote>
  <p>pip3 install pyocr</p>
</blockquote>

<blockquote>
  <p>selenium2.45</p>
</blockquote>

<blockquote>
  <p>Chrome47.0.2526.106 m or Firebox32.0.1</p>
</blockquote>

<blockquote>
  <p>chromedriver.exe</p>
</blockquote>

<h3 id="图像识别验证码请参考我的博客">图像识别验证码请参考我的博客：</h3>
<p><a href="http://www.cnblogs.com/TTyb/p/5996847.html">python图像识别–验证码</a></p>

<h3 id="selenium用法请参考我的博客">selenium用法请参考我的博客：</h3>
<p><a href="http://www.cnblogs.com/TTyb/p/5842015.html">python之selenium</a></p>

<h3 id="进入百度指数需要登陆登陆的账号密码写在文本account里面">进入百度指数需要登陆，登陆的账号密码写在文本account里面：</h3>
<p><img src="http://images2015.cnblogs.com/blog/996148/201611/996148-20161110153714827-1835068903.png" alt="" /></p>

<h3 id="万能登陆代码如下">万能登陆代码如下：</h3>

<div class="highlighter-rouge"><pre class="highlight"><code># 打开浏览器
def openbrowser():
    global browser

    # https://passport.baidu.com/v2/?login
    url = "https://passport.baidu.com/v2/?login&amp;tpl=mn&amp;u=http%3A%2F%2Fwww.baidu.com%2F"
    # 打开谷歌浏览器
    # Firefox()
    # Chrome()
    browser = webdriver.Chrome()
    # 输入网址
    browser.get(url)
    # 打开浏览器时间
    # print("等待10秒打开浏览器...")
    # time.sleep(10)

    # 找到id="TANGRAM__PSP_3__userName"的对话框
    # 清空输入框
    browser.find_element_by_id("TANGRAM__PSP_3__userName").clear()
    browser.find_element_by_id("TANGRAM__PSP_3__password").clear()

    # 输入账号密码
    # 输入账号密码
    account = []
    try:
        fileaccount = open("../baidu/account.txt")
        accounts = fileaccount.readlines()
        for acc in accounts:
            account.append(acc.strip())
        fileaccount.close()
    except Exception as err:
        print(err)
        input("请正确在account.txt里面写入账号密码")
        exit()
    browser.find_element_by_id("TANGRAM__PSP_3__userName").send_keys(account[0])
    browser.find_element_by_id("TANGRAM__PSP_3__password").send_keys(account[1])

    # 点击登陆登陆
    # id="TANGRAM__PSP_3__submit"
    browser.find_element_by_id("TANGRAM__PSP_3__submit").click()

    # 等待登陆10秒
    # print('等待登陆10秒...')
    # time.sleep(10)
    print("等待网址加载完毕...")

    select = input("请观察浏览器网站是否已经登陆(y/n)：")
    while 1:
        if select == "y" or select == "Y":
            print("登陆成功！")
            print("准备打开新的窗口...")
            # time.sleep(1)
            # browser.quit()
            break

        elif select == "n" or select == "N":
            selectno = input("账号密码错误请按0，验证码出现请按1...")
            # 账号密码错误则重新输入
            if selectno == "0":

                # 找到id="TANGRAM__PSP_3__userName"的对话框
                # 清空输入框
                browser.find_element_by_id("TANGRAM__PSP_3__userName").clear()
                browser.find_element_by_id("TANGRAM__PSP_3__password").clear()

                # 输入账号密码
                account = []
                try:
                    fileaccount = open("../baidu/account.txt")
                    accounts = fileaccount.readlines()
                    for acc in accounts:
                        account.append(acc.strip())
                    fileaccount.close()
                except Exception as err:
                    print(err)
                    input("请正确在account.txt里面写入账号密码")
                    exit()

                browser.find_element_by_id("TANGRAM__PSP_3__userName").send_keys(account[0])
                browser.find_element_by_id("TANGRAM__PSP_3__password").send_keys(account[1])
                # 点击登陆sign in
                # id="TANGRAM__PSP_3__submit"
                browser.find_element_by_id("TANGRAM__PSP_3__submit").click()

            elif selectno == "1":
                # 验证码的id为id="ap_captcha_guess"的对话框
                input("请在浏览器中输入验证码并登陆...")
                select = input("请观察浏览器网站是否已经登陆(y/n)：")

        else:
            print("请输入“y”或者“n”！")
            select = input("请观察浏览器网站是否已经登陆(y/n)：")
</code></pre>
</div>

<h3 id="登陆的页面">登陆的页面：</h3>
<p><img src="http://images2015.cnblogs.com/blog/996148/201611/996148-20161110154107624-1393804790.png" alt="" /></p>

<h3 id="登陆过后需要打开新的窗口也就是打开百度指数并且切换窗口在selenium用">登陆过后需要打开新的窗口，也就是打开百度指数，并且切换窗口，在selenium用：</h3>

<div class="highlighter-rouge"><pre class="highlight"><code># 新开一个窗口，通过执行js来新开一个窗口
js = 'window.open("http://index.baidu.com");'
browser.execute_script(js)
# 新窗口句柄切换，进入百度指数
# 获得当前打开所有窗口的句柄handles
# handles为一个数组
handles = browser.window_handles
# print(handles)
# 切换到当前最新打开的窗口
browser.switch_to_window(handles[-1])

</code></pre>
</div>

<h3 id="清空输入框构造点击天数">清空输入框，构造点击天数：</h3>

<div class="highlighter-rouge"><pre class="highlight"><code># 清空输入框
browser.find_element_by_id("schword").clear()
# 写入需要搜索的百度指数
browser.find_element_by_id("schword").send_keys(keyword)
# 点击搜索
# &lt;input type="submit" value="" id="searchWords" onclick="searchDemoWords()"&gt;
browser.find_element_by_id("searchWords").click()
time.sleep(2)
# 最大化窗口
browser.maximize_window()
# 构造天数
sel = int(input("查询7天请按0，30天请按1，90天请按2，半年请按3："))
day = 0
if sel == 0:
    day = 7
elif sel == 1:
    day = 30
elif sel == 2:
    day = 90
elif sel == 3:
    day = 180
sel = '//a[@rel="' + str(day) + '"]'
browser.find_element_by_xpath(sel).click()
# 太快了
time.sleep(2)
</code></pre>
</div>

<h3 id="天数也就是这里">天数也就是这里：</h3>
<p><img src="http://images2015.cnblogs.com/blog/996148/201611/996148-20161110154603561-1092775179.png" alt="" /></p>

<h3 id="找到图形框">找到图形框：</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>xoyelement = browser.find_elements_by_css_selector("#trend rect")[2]
</code></pre>
</div>

<h3 id="图形框就是">图形框就是：</h3>
<p><img src="http://images2015.cnblogs.com/blog/996148/201611/996148-20161110154817608-982142410.png" alt="" /></p>

<h3 id="根据坐标点的不同构造偏移量">根据坐标点的不同构造偏移量：</h3>
<p><img src="http://images2015.cnblogs.com/blog/996148/201611/996148-20161110155142530-319352053.png" alt="" /></p>

<h3 id="选取7天的坐标来观察">选取7天的坐标来观察：</h3>
<blockquote>
  <p>第一个点的横坐标为1031.66666</p>
</blockquote>

<blockquote>
  <p>第二个点的横坐标为1234
<img src="http://images2015.cnblogs.com/blog/996148/201611/996148-20161110155720764-1186100464.png" alt="" /></p>
</blockquote>

<p>所以7天两个坐标之间的差为：202.33，其他的天数类似</p>

<h3 id="用selenium库来模拟鼠标滑动悬浮">用selenium库来模拟鼠标滑动悬浮：</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>from selenium.webdriver.common.action_chains import ActionChains
ActionChains(browser).move_to_element_with_offset(xoyelement,x_0,y_0).perform()
</code></pre>
</div>

<h3 id="但是这样子确定的点指出是在这个位置">但是这样子确定的点指出是在这个位置：</h3>
<p><img src="http://images2015.cnblogs.com/blog/996148/201611/996148-20161110155752202-120333333.png" alt="" /></p>

<p>也就是矩形的左上角，这里是不会加载js显示弹出框的，所以要给横坐标+1：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>x_0 = 1
y_0 = 0
</code></pre>
</div>

<h3 id="写个按照天数的循环让横坐标累加">写个按照天数的循环，让横坐标累加：</h3>

<div class="highlighter-rouge"><pre class="highlight"><code># 按照选择的天数循环
for i in range(day):
    # 构造规则
    if day == 7:
        x_0 = x_0 + 202.33
    elif day == 30:
        x_0 = x_0 + 41.68
    elif day == 90:
        x_0 = x_0 + 13.64
    elif day == 180:
        x_0 = x_0 + 6.78
</code></pre>
</div>

<h3 id="鼠标横移时会弹出框在网址里面找到这个框">鼠标横移时会弹出框，在网址里面找到这个框：</h3>
<p><img src="http://images2015.cnblogs.com/blog/996148/201611/996148-20161110160257592-723215476.png" alt="" /></p>

<h3 id="selenium自动识别之">selenium自动识别之…：</h3>

<div class="highlighter-rouge"><pre class="highlight"><code># &lt;div class="imgtxt" style="margin-left:-117px;"&gt;&lt;/div&gt;
imgelement = browser.find_element_by_xpath('//div[@id="viewbox"]')
</code></pre>
</div>

<h3 id="并且确定这个框的大小位置">并且确定这个框的大小位置：</h3>

<div class="highlighter-rouge"><pre class="highlight"><code># 找到图片坐标
locations = imgelement.location
print(locations)
# 找到图片大小
sizes = imgelement.size
print(sizes)
# 构造指数的位置
rangle = (int(locations['x']), int(locations['y']), int(locations['x'] + sizes['width']),
          int(locations['y'] + sizes['height']))
</code></pre>
</div>

<p>截取的图形为：
<img src="http://images2015.cnblogs.com/blog/996148/201611/996148-20161110160502389-924750650.png" alt="" /></p>

<h3 id="下面的思路就是">下面的思路就是：</h3>
<blockquote>
  <ol>
    <li>将整个屏幕截图下来</li>
    <li>打开截图用上面得到的这个坐标rangle进行裁剪</li>
  </ol>
</blockquote>

<h3 id="但是最后裁剪出来的是上面的那个黑框我想要的效果是">但是最后裁剪出来的是上面的那个黑框，我想要的效果是：</h3>
<p><img src="http://images2015.cnblogs.com/blog/996148/201611/996148-20161110160724577-1831216031.jpg" alt="" /></p>

<h3 id="所以要对rangle进行计算但是我懒忽略了搜索词的长度直接暴力的写成">所以要对rangle进行计算，但是我懒，忽略了搜索词的长度，直接暴力的写成：</h3>

<div class="highlighter-rouge"><pre class="highlight"><code># 构造指数的位置
rangle = (int(locations['x'] + sizes['width']/3), int(locations['y'] + sizes['height']/2), int(locations['x'] + sizes['width']*2/3),
          int(locations['y'] + sizes['height']))
</code></pre>
</div>

<h3 id="这个写法最终不太好最起码要对keyword的长度进行判断长度过长会导致截图坐标出现偏差反正我知道怎么做就是不写出来给你们看">这个写法最终不太好，最起码要对keyword的长度进行判断，长度过长会导致截图坐标出现偏差，反正我知道怎么做，就是不写出来给你们看！</h3>

<h3 id="后面的完整代码是">后面的完整代码是：</h3>

<div class="highlighter-rouge"><pre class="highlight"><code># &lt;div class="imgtxt" style="margin-left:-117px;"&gt;&lt;/div&gt;
imgelement = browser.find_element_by_xpath('//div[@id="viewbox"]')
# 找到图片坐标
locations = imgelement.location
print(locations)
# 找到图片大小
sizes = imgelement.size
print(sizes)
# 构造指数的位置
rangle = (int(locations['x'] + sizes['width']/3), int(locations['y'] + sizes['height']/2), int(locations['x'] + sizes['width']*2/3),
          int(locations['y'] + sizes['height']))
# 截取当前浏览器
path = "../baidu/" + str(num)
browser.save_screenshot(str(path) + ".png")
# 打开截图切割
img = Image.open(str(path) + ".png")
jpg = img.crop(rangle)
jpg.save(str(path) + ".jpg")
</code></pre>
</div>

<h3 id="但是后面发现裁剪的图片太小识别精度太低所以需要对图片进行扩大">但是后面发现裁剪的图片太小，识别精度太低，所以需要对图片进行扩大：</h3>

<div class="highlighter-rouge"><pre class="highlight"><code># 将图片放大一倍
# 原图大小73.29
jpgzoom = Image.open(str(path) + ".jpg")
(x, y) = jpgzoom.size
x_s = 146
y_s = 58
out = jpgzoom.resize((x_s, y_s), Image.ANTIALIAS)
out.save(path + 'zoom.jpg', 'png', quality=95)
</code></pre>
</div>

<p>原图大小请 <strong>右键-&gt;属性-&gt;详细信息</strong> 查看，我的是长73像素，宽29像素</p>

<h3 id="最后就是图像识别">最后就是图像识别</h3>

<div class="highlighter-rouge"><pre class="highlight"><code># 图像识别
index = []
image = Image.open(str(path) + "zoom.jpg")
code = pytesseract.image_to_string(image)
if code:
    index.append(code)
</code></pre>
</div>

<h3 id="最后效果图">最后效果图：</h3>
<p><img src="http://images2015.cnblogs.com/blog/996148/201611/996148-20161110161512889-300916957.png" alt="" /></p>

<p><img src="http://images2015.cnblogs.com/blog/996148/201611/996148-20161110161525874-60911542.png" alt="" /></p>

<h2 id="代码在我的github上面">代码在我的github上面：</h2>
<p><a href="https://github.com/TTyb">TTyb</a></p>

        </p>
    </div>
    <!-- 多说评论框 start -->
<div class="ds-thread" data-thread-key="http://localhost:4000/python/python3%E7%99%BE%E5%BA%A6%E6%8C%87%E6%95%B0%E6%8A%93%E5%8F%96.html"
     data-title="python3百度指数抓取" data-url="http://localhost:4000/python/python3%E7%99%BE%E5%BA%A6%E6%8C%87%E6%95%B0%E6%8A%93%E5%8F%96.html"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"ttyb"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0]
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();

</script>
<!-- 多说公共JS代码 end -->

</div>


    
<a class="gototop"></a>
<div class="container">
    <div id="footer" class="text-muted">
        <div style="font-family: 'Lato', sans-serif;">
            <div class="foo">
                <span class="letter" data-letter="T">T</span>
                <span class="letter" data-letter="T">T</span>
                <span class="letter" data-letter="y">y</span>
                <span class="letter" data-letter="b">b</span>
            </div>
        </div>
        <h3 style="font-size: 1.2em;font-family: KaiTi;">无聊就想打码 打码使我快乐</h3>
        <div style="font-size: 1.2em;font-family: KaiTi;">
            不用多久<br/>
            我就会升职加薪<br/>
            当上总经理<br/>
            出任CEO<br/>
            迎娶白富美<br/>
            走上人生巅峰
        </div>
    </div>
</div>
<footer id="footer">
    <ul class="icons">
        <li><a href="/contact" class="icon fa-qq"><span class="label">QQ</span></a></li>
        <li><a href="https://github.com/TTyb" class="icon fa-github"><span class="label">Github</span></a></li>
        <li><a href="/" class="icon fa-home"><span class="label">首页</span></a></li>
        <li><a href="http://www.cnblogs.com/TTyb/" class="icon fa-heart"><span class="label">博客园</span></a></li>
        <li><a href="/404" class="icon fa-map-signs"><span class="label">404</span></a></li>
    </ul>
    <p class="copyright">Copyright &copy; TTyb All rights reserved.</p>
</footer>

<script type="text/javascript" src="/static/js/jquery.gototop.min.js"></script>
<script type="text/javascript">
    $(function(){
            // $(".gototop").gototop();
            $(".gototop").gototop({
                position : 0,
                duration : 1250,
                visibleAt : 300,
                classname : "isvisible"
            });
        });
</script>


</body>
</html>
